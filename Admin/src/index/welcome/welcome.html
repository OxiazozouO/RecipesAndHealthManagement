<!DOCTYPE html>
<html class="x-admin-sm" lang="">
<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="stylesheet" href="../../../css/font.css">
    <link rel="stylesheet" href="../../../css/xadmin.css">
    <script type="text/javascript" src="../../../lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../js/xadmin.js"></script>
    <script type="text/javascript" src="../../../js/httpUtil.js"></script>
    <script src="../../../lib/echarts.5.4.3.js"></script>
    <style>
        /* æ–°å¢å…¨å±€æ ·å¼æ›¿ä»£Tailwind */
        .dashboard-container {
            padding: 1.5rem;
            background-color: #f3f4f6;
        }
        .grid-container {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }

        @media (min-width: 768px) {
            .md-grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .md-grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .md-grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        }
        @media (min-width: 1024px) {
            .lg-grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .lg-grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        }

        .kpi-card {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            padding: 1.5rem;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: auto;
            height: 400px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a365d;
            margin-bottom: 1rem;
        }

        .section-divider {
            border-bottom: 2px solid #e2e8f0;
            margin: 2rem 0;
        }

        /* Flexå¸ƒå±€æ›¿ä»£ */
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .text-lg { font-size: 1.125rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
    </style>
</head>
<body class="dashboard-container">
<!-- KPI å¡ç‰‡åŒºåŸŸ -->
<div class="section-title">ç»Ÿè®¡ä¿¡æ¯</div>
<div class="grid-container grid-cols-1 md-grid-cols-2 lg-grid-cols-4" id="kpi-cards"></div>
<div class="section-divider"></div>
<div class="grid-container grid-cols-1 md-grid-cols-2 lg-grid-cols-3">
    <div class="chart-container" id="content-category-distribution"></div>
    <div class="chart-container" id="tag-usage"></div>
    <div class="chart-container" id="top-report-type"></div>
</div>
<div class="section-divider"></div>
<div class="section-title">å®¡æ ¸ç›¸å…³</div>
<div class="grid-container grid-cols-1 md-grid-cols-2 lg-grid-cols-3">
    <div class="chart-container" id="content-trend"></div>
    <div class="chart-container" id="approval-status"></div>
    <div class="chart-container" id="approval-rate"></div>
</div>

<script>
    let mockData = []
    const aid = sessionStorage.getItem('aid')

    httpTool.execute(urls.GetDashboardData, {AdminId: aid})
        .then(res => {
            if (res === undefined) return
            mockData = res.data
            // æ–°å¢ï¼šè½¬æ¢å­—å…¸æ•°æ®ä¸ºæ’åºåçš„æ•°ç»„æ ¼å¼
            const processTrendData = (dict) => {
                return Object.entries(dict)
                    .map(([dateStr, value]) => ({
                        // è½¬æ¢æ—¥æœŸæ ¼å¼ä¸º MM-DD
                        date: new Date(dateStr).toISOString().slice(5, 10),
                        value: value
                    }))
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
            };
            const trendData = mockData.charts.contentTrend;

            // å¤„ç†ä¸‰ä¸ªè¶‹åŠ¿æ•°æ®é›†
            mockData.charts.contentTrend = {
                recipes: processTrendData(trendData.recipesTrend),
                ingredients: processTrendData(trendData.ingredientsTrend),
                collections: processTrendData(trendData.collectionsTrend)
            };

            // // åˆå§‹åŒ–
            renderKPICards();
            initCharts();
        })
</script>
<script>
    function renderKPICards() {
        const metrics = mockData.metrics;
        const data = [
            {title: 'æ´»è·ƒç”¨æˆ·', value: metrics.usersActive || 0, trend: 'ğŸ‘¥'},
            {title: 'é£Ÿææ•°', value: metrics.ingredientsCount || 0, trend: 'ğŸ¥¦'},
            {title: 'é£Ÿè°±æ•°', value: metrics.recipesCount || 0, trend: 'ğŸ“–'},
            {title: 'åˆé›†æ•°', value: metrics.collectionsCount || 0, trend: 'ğŸ—‚ï¸'},
            {title: 'å¾…å®¡æ ¸å†…å®¹', value: metrics.audit.pending || 0, trend: 'â³'},
            {title: 'å·²å®¡æ ¸å†…å®¹', value: metrics.audit.approved || 0, trend: 'âœ…'}
        ];
        document.getElementById('kpi-cards').innerHTML = data.map(d => `
                <div class="kpi-card p-6">
                  <div class="flex justify-between">
                    <div>
                      <div class="text-lg font-semibold">${d.title}</div>
                      <div class="text-3xl font-bold">${d.value}</div>
                    </div>
                    <div class="text-4xl">${d.trend}</div>
                  </div>
                </div>`).join('');
    }

    // å›¾è¡¨åˆå§‹åŒ–
    function initCharts() {
        try {
            const chartConfigs = [
                {id: 'approval-status', option: getApprovalStatusOption()},
                {id: 'top-report-type', option: getTopReportTypeOption()},
                {id: 'content-trend', option: getContentTrendOption()},
                {id: 'content-category-distribution', option: getContentCategoryDistributionOption()},
                {id: 'tag-usage', option: getTagUsageOption()},
                {id: 'approval-rate', option: getApprovalRateOption()}
            ];

            chartConfigs.forEach(({id, option}) => {
                const cc = echarts.init(document.getElementById(id));
                cc.setOption(option);
                window.addEventListener('resize', () => cc.resize());
            });
        } catch (error) {
            console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
        }
    }

    // å†…å®¹å®¡æ ¸çŠ¶æ€å›¾è¡¨é…ç½®ï¼ˆä½¿ç”¨æ¼æ–—å›¾ï¼‰
    function getApprovalStatusOption() {
        const audit = mockData.metrics.audit
        return {
            title: {text: 'å†…å®¹å®¡æ ¸çŠ¶æ€', left: 'center', textStyle: {fontSize: 18, fontWeight: 'bold'}},
            tooltip: {trigger: 'item', formatter: '{a} <br/>{b} : {c}'},
            series: [{
                name: 'å®¡æ ¸çŠ¶æ€',
                type: 'funnel',
                left: '10%',
                top: 60,
                bottom: 60,
                width: '80%',
                min: 0,
                max: audit.pending + audit.approved + audit.rejected + audit.locked,
                minSize: '0%',
                maxSize: '100%',
                sort: 'descending',
                gap: 2,
                label: {
                    show: true,
                    position: 'inside'
                },
                labelLine: {
                    length: 10,
                    lineStyle: {
                        width: 1,
                        type: 'solid'
                    }
                },
                itemStyle: {
                    borderColor: '#fff',
                    borderWidth: 2
                },
                data: [
                    {value: audit.pending, name: 'å¾…å®¡æ ¸'},
                    {value: audit.approved, name: 'å·²å®¡æ ¸'},
                    {value: audit.rejected, name: 'å·²ä¸‹æ¶'},
                    {value: audit.locked, name: 'å®¡æ ¸å·²é”å®š'}
                ]
            }],
            color: ['#5470c6', '#91cc75', '#ee6666', '#fac858']
        };
    }

    // é«˜é¢‘ä¸¾æŠ¥ç±»å‹å›¾è¡¨é…ç½®
    function getTopReportTypeOption() {
        const report = mockData.charts.report;
        return {
            title: {text: 'é«˜é¢‘ä¸¾æŠ¥ç±»å‹', left: 'center', textStyle: {fontSize: 18, fontWeight: 'bold'}},
            tooltip: {trigger: 'item', formatter: '{b}: {c}'},
            series: [{
                name: 'ä¸¾æŠ¥ç±»å‹',
                type: 'pie',
                radius: '50%',
                data: report,
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }],
            color: ['#5470c6', '#91cc75', '#ee6666', '#fac858']
        };
    }

    // å†…å®¹å¢é•¿è¶‹åŠ¿å›¾è¡¨é…ç½®
    function getContentTrendOption() {
        const trendData = mockData.charts.contentTrend;
        const dates = trendData.recipes.map(d => d.date);
        return {
            title: {text: 'å†…å®¹å‘å¸ƒè¶‹åŠ¿', left: 'center', textStyle: {fontSize: 18, fontWeight: 'bold'}},
            tooltip: {trigger: 'axis'},
            xAxis: {data: dates},
            yAxis: {type: 'value'},
            legend: {data: ['é£Ÿè°±', 'é£Ÿæ', 'åˆé›†'], bottom: 0},
            series: [
                {name: 'é£Ÿè°±', type: 'line', data: trendData.recipes.map(d => d.value)},
                {name: 'é£Ÿæ', type: 'line', data: trendData.ingredients.map(d => d.value)},
                {name: 'åˆé›†', type: 'line', data: trendData.collections.map(d => d.value)}
            ],
            color: ['#5470c6', '#91cc75', '#fac858']
        };
    }

    // å†…å®¹åˆ†ç±»åˆ†å¸ƒå›¾è¡¨é…ç½®
    function getContentCategoryDistributionOption() {
        const metrics = mockData.metrics;
        return {
            title: {text: 'å†…å®¹åˆ†ç±»åˆ†å¸ƒ', left: 'center', textStyle: {fontSize: 18, fontWeight: 'bold'}},
            tooltip: {trigger: 'item', formatter: '{b}: {c} ({d}%)'},
            series: [{
                name: 'å†…å®¹åˆ†ç±»',
                type: 'pie',
                radius: '50%',
                data: [
                    {value: metrics.ingredientsCount, name: 'é£Ÿæ'},
                    {value: metrics.recipesCount, name: 'é£Ÿè°±'},
                    {value: metrics.collectionsCount, name: 'åˆ†ç±»'},
                ],
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }],
            color: ['#5470c6', '#91cc75', '#fac858']
        };
    }

    // æ ‡ç­¾ä½¿ç”¨æƒ…å†µå›¾è¡¨é…ç½®
    function getTagUsageOption() {
        const tags = mockData.charts.tags;
        return {
            title: {text: 'æ ‡ç­¾ä½¿ç”¨æƒ…å†µ', left: 'center', textStyle: {fontSize: 18, fontWeight: 'bold'}},
            tooltip: {trigger: 'axis'},
            xAxis: {
                type: 'category',
                data: tags.map(item => item.name)
            },
            yAxis: {type: 'value'},
            series: [{
                data: tags.map(item => item.value),
                type: 'bar',
                itemStyle: {color: '#ee6666'}
            }]
        };
    }

    // å®¡æ ¸é€šè¿‡ç‡å›¾è¡¨é…ç½®
    function getApprovalRateOption() {
        const metrics = mockData.metrics;
        return {
            title: {text: 'å®¡æ ¸é€šè¿‡ç‡', left: 'center', textStyle: {fontSize: 18, fontWeight: 'bold'}},
            tooltip: {trigger: 'item', formatter: '{b}: {c}%'},
            series: [{
                name: 'å®¡æ ¸é€šè¿‡ç‡',
                type: 'gauge',
                detail: {formatter: '{value}%'},
                data: [{value: metrics.approvalRate, name: 'é€šè¿‡ç‡'}]
            }]
        };
    }
</script>
</body>
</html>